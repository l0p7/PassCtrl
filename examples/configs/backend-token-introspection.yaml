# Bearer token introspection example that validates inbound requests against an
# identity service before granting access. This configuration demonstrates
# forward proxy enforcement, curated request headers, rule-level caching, and
# CEL-based conditional logic aligned with the staged documentation.
server:
  listen:
    address: "0.0.0.0"
    port: 8080
  logging:
    level: debug
    format: json
  rules:
    rulesFolder: ""
    rulesFile: ""
  templates:
    templatesFolder: "./templates"
    templatesAllowEnv: false

endpoints:
  introspection:
    description: "Validates bearer tokens via the identity API before granting access."
    authentication:
      required: true
      allow:
        authorization: ["bearer"]
      challenge:
        type: bearer
        realm: "Identity"
    forwardProxyPolicy:
      trustedProxyIPs: ["10.0.0.0/8", "192.168.0.0/16"]
      developmentMode: false
    forwardRequestPolicy:
      forwardProxyHeaders: true
    rules:
      - name: introspect-bearer-token
      - name: require-active-subscription
    responsePolicy:
      pass:
        status: 200
      fail:
        status: 403
        headers:
          X-PassCtrl-Reason: "{{ .response.failure_reason }}"
          X-PassCtrl-Plan: "{{ .response.subscription_plan }}"
        body: |
          {
            "error": "access denied"
          }
      error:
        status: 502
        body: |
          {
            "error": "identity service unavailable"
          }
    cache:
      resultTTL: "120s"

rules:
  introspect-bearer-token:
    description: "Calls the identity service to validate the inbound bearer token."
    auth:
      - match:
          - type: bearer
        forwardAs:
          - type: bearer
            token: "{{ .auth.input.bearer.token }}"
    backendApi:
      url: "https://identity.internal/api/v1/introspect"
      method: POST
      forwardProxyHeaders: true
      headers:
        content-type: "application/json"
        x-request-id: null  # Copy from request
        x-trace-id: "{{ .request.headers.x-request-id }}"  # Template value
      query:
        trace_id: null  # Copy from request
      body: |
        {
          "token": "{{ .auth.input.bearer.token }}"
        }
      acceptedStatuses: [200]
    conditions:
      pass:
        # Use has() for safe field access
        - has(backend.body.active) && backend.body.active == true
      fail:
        # Explicit failure: token is inactive
        - has(backend.body.active) && backend.body.active == false
      error:
        # Server errors and network failures
        - backend.status >= 500
        - backend.status == 0
    variables:
      validated_token: backend.body.token
      subscription_plan: backend.body.plan
      subject: backend.body.sub
    responses:
      pass:
        variables:
          validated_token: variables.validated_token
          subscription_plan: variables.subscription_plan
          subject: variables.subject
    cache:
      followCacheControl: true
      passTTL: "90s"
      failTTL: "0s"

  require-active-subscription:
    description: "Ensures the identity API flagged the account as active."
    conditions:
      pass:
        # Check if rule variables exist and validate subscription
        - '"introspect-bearer-token" in variables.rule'
        - 'lookup(variables.rule["introspect-bearer-token"], "validated_token") != ""'
        - 'lookup(variables.rule["introspect-bearer-token"], "subscription_plan") in ["plus", "enterprise"]'
      fail:
        # Explicit failure: expired subscription
        - 'lookup(variables.rule["introspect-bearer-token"], "subscription_plan") == "expired"'
        - 'lookup(variables.rule["introspect-bearer-token"], "validated_token") == ""'
    responses:
      fail:
        variables:
          failure_reason: "subscription check failed"
          subscription_plan: "{{ .rules.introspect-bearer-token.variables.subscription_plan }}"
    cache:
      passTTL: "0s"
      failTTL: "0s"
