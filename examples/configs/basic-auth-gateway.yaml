# Basic authentication gateway showcasing a single endpoint with inline rules.
# Feed this file to the CLI with `--config` to load the endpoint and rule definitions.
server:
  listen:
    address: "0.0.0.0"
    port: 8080
  logging:
    level: info
    format: json
  rules:
    # Disable external rule sources so the inline definitions below are authoritative.
    rulesFolder: ""
    rulesFile: ""
  templates:
    templatesFolder: "./templates"
    templatesAllowEnv: false

endpoints:
  basic-gateway:
    description: "Protects the /auth endpoint with HTTP Basic credentials."
    authentication:
      required: true
      allow:
        authorization: ["basic"]
      challenge:
        type: basic
        realm: "Internal"
        charset: "UTF-8"
    forwardRequestPolicy:
      # Use null-copy semantics: null = copy from raw request, value = static/template
      # To forward X-Request-ID from raw request:
      headers:
        x-request-id: null
      query: {}
    rules:
      - name: require-basic-login
    responsePolicy:
      pass:
        status: 200
        headers:
          X-Auth-Result: "{{ .response.auth_result }}"
          X-Auth-User: "{{ .response.username }}"
          X-Auth-Role: "{{ .response.role }}"
        body: |
          {
            "status": "authenticated",
            "role": "{{ .response.role }}",
            "endpoint": "{{ .endpoint }}"
          }
      fail:
        status: 401
        body: |
          {
            "error": "authentication required",
            "endpoint": "{{ .endpoint }}"
          }
        headers:
          X-Auth-Result: "{{ .response.auth_result }}"
      error:
        status: 500
        body: |
          {
            "error": "upstream unavailable"
          }

rules:
  require-basic-login:
    description: "Accepts known Basic credentials and validates username against allowed pattern."
    auth:
      - match:
          - type: basic
            username: ["/^admin-.*/", "/^user-.*/"]  # Regex patterns: match admin-* or user-*
        forwardAs:
          - type: basic
            user: "{{ .auth.input.basic.user }}"
            password: "{{ .auth.input.basic.password }}"
    variables:
      user_prefix: "{{ .auth.input.basic.user | split \"-\" | first }}"
      user_role: '{{ if hasPrefix "admin-" .auth.input.basic.user }}admin{{ else }}user{{ end }}'
    responses:
      pass:
        variables:
          auth_result: "authenticated"
          username: variables.user_prefix
          role: variables.user_role
      fail:
        variables:
          auth_result: "invalid credentials"
    cache:
      passTTL: "0s"  # Disable caching for demo purposes
      failTTL: "0s"
