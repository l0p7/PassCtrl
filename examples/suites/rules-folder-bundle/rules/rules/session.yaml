rules:
  lookup-session:
    description: "Queries the session service for user metadata and entitlement flags."
    auth:
      - match:
          - type: header
            name: x-session-token
        forwardAs:
          - type: bearer
            token: "{{ index .auth.input.header \"x-session-token\" }}"
    backendApi:
      url: "https://session.internal/v1/lookup"
      method: GET
      headers:
        x-session-token: null
        authorization: "Bearer {{ index .auth.input.header \"x-session-token\" }}"
      acceptedStatuses: [200]
    conditions:
      pass:
        # Use has() for safe field access
        - has(backend.body.active) && backend.body.active == true
      fail:
        # Explicit failure: session is not active
        - has(backend.body.active) && backend.body.active == false
    variables:
      user_id: backend.body.userId
      tenant_id: backend.body.tenant
      entitlement: backend.body.entitlement
    responses:
      pass:
        variables:
          user_id: variables.user_id
          tenant_id: variables.tenant_id
          entitlement: variables.entitlement
    cache:
      passTTL: "2m"
      failTTL: "30s"

  require-entitlement:
    description: "Allows requests only when the session advertises an allow entitlement."
    conditions:
      pass:
        # Check if session rule variables exist and validate entitlement
        - '"lookup-session" in variables.rule'
        - 'lookup(variables.rule["lookup-session"], "entitlement") == "allow"'
      fail:
        # Explicit failure: entitlement denied
        - 'lookup(variables.rule["lookup-session"], "entitlement") == "deny"'
    responses:
      fail:
        variables:
          entitlement_status: "denied"
          tenant_id: "{{ .rules.lookup-session.variables.tenant_id }}"
    cache:
      passTTL: "0s"
      failTTL: "0s"
