rules:
  lookup-session:
    description: "Queries the session service for user metadata and entitlement flags."
    auth:
      - type: header
        name: x-session-token
        forwardAs:
          type: bearer
          token: "{{ .auth.input.value }}"
    backendApi:
      url: "https://session.internal/v1/lookup"
      method: GET
      headers:
        allow: ["x-session-token"]
        strip: []
        custom:
          authorization: "Bearer {{ .auth.input.value }}"
      acceptedStatuses: [200]
    conditions:
      pass:
        - lookup(backend.body, "active") == true
      fail:
        - lookup(backend.body, "active") != true
    variables:
      user_id: backend.body.userId
      tenant_id: backend.body.tenant
      entitlement: backend.body.entitlement
    responses:
      pass:
        variables:
          user_id: variables.user_id
          tenant_id: variables.tenant_id
          entitlement: variables.entitlement
    cache:
      passTTL: "2m"
      failTTL: "30s"

  require-entitlement:
    description: "Allows requests only when the session advertises an allow entitlement."
    conditions:
      pass:
        - lookup(vars.rules["lookup-session"], "entitlement") == "allow"
      fail:
        - lookup(vars.rules["lookup-session"], "entitlement") == "deny"
    responses:
      fail:
        headers:
          custom:
            X-Entitlement: "denied"
            X-Tenant-Id: "{{ index .rules \"lookup-session\" \"variables\" \"tenant_id\" }}"
    cache:
      passTTL: "0s"
      failTTL: "0s"
