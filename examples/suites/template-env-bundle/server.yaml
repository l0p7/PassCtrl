# Inline configuration demonstrating environment-aware templates and headers.
server:
  listen:
    address: "0.0.0.0"
    port: 8080
  logging:
    level: info
    format: json
    correlationHeader: "X-Request-ID"
  rules:
    rulesFolder: ""
    rulesFile: ""
  templates:
    templatesFolder: "./examples/suites/template-env-bundle/templates"
  variables:
    environment:
      SUPPORT_EMAIL: null  # null-copy: read from environment variable SUPPORT_EMAIL
      UPSTREAM_BASE_URL: null  # null-copy: read from environment variable UPSTREAM_BASE_URL

endpoints:
  env-aware-gateway:
    description: "Renders environment-derived deny messages and forwards curated headers."
    authentication:
      required: true
      allow:
        authorization: ["basic"]
      challenge:
        type: basic
        realm: "Env Demo"
        charset: "UTF-8"
    forwardRequestPolicy:
      headers:
        x-request-id: null
        x-upstream-base: "{{ .variables.environment.UPSTREAM_BASE_URL }}"
    rules:
      - name: require-authenticated-admission
    responsePolicy:
      pass:
        status: 204
      fail:
        status: 403
        bodyFile: "deny.json.tmpl"
        headers:
          X-Support-Contact: "{{ .response.support_contact }}"
      error:
        status: 502
        body: |
          {
            "error": "unexpected failure",
            "support": "{{ .variables.environment.SUPPORT_EMAIL }}"
          }
    cache:
      resultTTL: "0s"

rules:
  require-authenticated-admission:
    description: "Passes only when the admission agent marked the request as authenticated."
    conditions:
      pass:
        - admission.authenticated == true
      fail:
        - admission.authenticated == false
    responses:
      fail:
        variables:
          support_contact: "{{ .variables.environment.SUPPORT_EMAIL }}"
