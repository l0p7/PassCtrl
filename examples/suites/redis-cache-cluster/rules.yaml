endpoints:
  cached-api:
    description: "Relies on Redis-backed caches to reuse profile lookups."
    authentication:
      required: true
      allow:
        authorization: ["bearer"]
      challenge:
        type: bearer
        realm: "External"
    forwardRequestPolicy:
      headers:
        authorization: null
        x-request-id: null
        x-user-segment: "external"
      query:
        trace: null
    rules:
      - name: fetch-profile
      - name: check-tier
    responsePolicy:
      pass:
        status: 200
        bodyFile: "pass.json.tmpl"
      fail:
        status: 403
        body: |
          {
            "error": "tier restriction",
            "reason": "{{ .response.tier_restriction_reason }}"
          }
    cache:
      resultTTL: "120s"

rules:
  fetch-profile:
    description: "Calls the profile service and caches pass/fail decisions separately."
    backendApi:
      url: "https://profile.internal/v2/profile"
      method: GET
      headers:
        authorization: "Bearer {{ .auth.input.bearer.token }}"
      acceptedStatuses: [200, 404]
    conditions:
      pass:
        # Use has() for safe field access
        - has(backend.body.active) && backend.body.active == true
      fail:
        # Explicit failure: profile is not active or not found
        - has(backend.body.active) && backend.body.active == false
        - backend.status == 404
    variables:
      user_id: backend.body.id
      plan: backend.body.plan
    responses:
      pass:
        variables:
          user_id: variables.user_id
          plan: variables.plan
    cache:
      followCacheControl: true
      passTTL: "5m"
      failTTL: "45s"

  check-tier:
    description: "Requires a paid subscription level before allowing access."
    conditions:
      pass:
        # Check if fetch-profile rule has exported variables
        - '"fetch-profile" in variables.rule'
        - 'lookup(variables.rule["fetch-profile"], "plan") in ["plus", "enterprise"]'
      fail:
        # Explicit failure: free plan
        - 'lookup(variables.rule["fetch-profile"], "plan") == "free"'
    responses:
      fail:
        variables:
          tier_restriction_reason: "plan upgrade required"
          passctrl_plan: "{{ .rules.fetch-profile.variables.plan }}"
    cache:
      passTTL: "0s"
      failTTL: "0s"
